<script>
  // üîë Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAc-BvWEJ-bxT91qK__m742tOGYFTz8h7M",
    authDomain: "bd-botanas-rikys.firebaseapp.com",
    projectId: "bd-botanas-rikys",
    storageBucket: "bd-botanas-rikys.firebasestorage.app",
    messagingSenderId: "694424815583",
    appId: "1:694424815583:web:04bc77bdfc4fbd4629e66a",
    measurementId: "G-8MNC3KE0Z2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // üßæ Recuperar datos
  const carrito = JSON.parse(localStorage.getItem("carrito") || "[]");
  const usuario = localStorage.getItem("usuario") || "Desconocido";
  const dep = localStorage.getItem("departamentoActual") || "General";

  // üßÆ Calcular total
  const total = carrito.reduce((a,b)=>a+b.precio_cliente*b.cantidad,0);

  // üì¶ Mostrar ticket
  const t = document.getElementById("ticket");
  if (carrito.length === 0) {
    t.innerHTML = "<p style='text-align:center;'>No hay productos en el carrito.</p>";
  } else {
    t.innerHTML = `<div><strong>Departamento:</strong> ${dep}</div>`;
    t.innerHTML += `<div><strong>Usuario:</strong> ${usuario}</div><hr>`;
    carrito.forEach(p=>{
      t.innerHTML += `<div>${p.cantidad}x ${p.nombre} <span style='float:right;'>$${(p.precio_cliente*p.cantidad).toFixed(2)}</span></div>`;
    });
    t.innerHTML += `<div class='total'>Total: $${total.toFixed(2)}</div>`;
  }

  async function confirmarVenta() {
    const tipo = document.getElementById("tipoPago").value;
    const mensaje = document.getElementById("mensaje");

    if (carrito.length === 0) {
      mensaje.innerHTML = "‚ö†Ô∏è No hay productos para cobrar.";
      return;
    }

    // üß© Subtotales por departamento
    const subtotalDepto = {};
    carrito.forEach(p => {
      const d = dep || "GENERAL";
      subtotalDepto[d] = (subtotalDepto[d] || 0) + (p.precio_cliente * p.cantidad);
    });

    // üßæ Estructura de venta
    const venta = {
      fecha: new Date().toISOString(),
      usuario,
      departamento: dep,
      productos: carrito,
      total,
      subtotales: subtotalDepto,
      tipo_pago: tipo,
      estado: "Completada",
      cortada: false,             // ‚ö†Ô∏è Nueva bandera
      fecha_corte: null,          // üïí Para cuando se cierre el corte
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    mensaje.innerHTML = "‚è≥ Guardando venta...";
    try {
      await db.collection("VENTASRICKYS").add(venta);
      mensaje.innerHTML = "‚úÖ Venta registrada correctamente.";

      // Limpiar datos
      localStorage.removeItem("carrito");
      localStorage.removeItem("departamentoActual");
      setTimeout(()=> location.href = "menu.html", 1500);
    } catch (e) {
      console.error(e);
      mensaje.innerHTML = "‚ùå Error al guardar la venta.";
    }
  }

  // üß© Service Worker (PWA)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>
